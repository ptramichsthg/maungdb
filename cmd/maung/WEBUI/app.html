<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MaungDB Studio</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/public/css/style_main.css" />
  <link rel="stylesheet" href="/public/css/style_table_designer.css" />

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>  
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
              mono: ['JetBrains Mono', 'monospace'],
            },
            colors: {
              maung: {
                50: '#fff7ed',
                100: '#ffedd5',
                500: '#f97316',
                600: '#ea580c',
                700: '#c2410c',
                900: '#7c2d12',
              }
            }
          }
        },
        corePlugins: {
          preflight: false,
        }
      }
    </script>

</head>
<body>

  <div class="overlay" onclick="toggleSidebar()"></div>

  <div class="app-layout">
    
    <aside class="sidebar">
      <div class="sidebar-header">

        <span style="margin-right: 10px;">üêØ</span> MaungDB Studio
      </div>

      <div class="user-profile">
        <div class="user-avatar">M</div>
        <div class="user-name" id="userName">User</div>
        <div class="user-role" id="userRole">Connecting...</div>
      </div>

      <nav class="nav-menu">
        <div class="nav-item active" onclick="switchTab('dashboard')">
          <span>üìä</span> Dashboard
        </div>
        <div class="nav-item" onclick="switchTab('database')">
          <span>üóÑÔ∏è</span> Database Manager
        </div>
        <div class="nav-item" onclick="switchTab('query')">
          <span>‚ö°</span> Query Console
        </div>
        <div class="nav-item" onclick="switchTab('schema')">
          <span>üìê</span> Table Designer
        </div>
        <a href="/public/docs.html" class="nav-item" style="text-decoration: none; color: inherit;">
          <span>üìù</span> Documentation
        </a>
      </nav>

      <div class="sidebar-footer">
        
        <button onclick="logout()" class="btn-logout">Sign Out</button>
      </div>
    </aside>

    <div class="main-wrapper">
      
      <header class="top-header">
        <div class="header-left">
          <button class="menu-btn" onclick="toggleSidebar()">‚ò∞</button>
          <div class="db-badge">
            <div class="dot" id="dbIndicator"></div>
            <span id="activeDBName">No Database Selected</span>
          </div>
        </div>
        <div class="server-version">
          Server v1.0.0
        </div>
      </header>

      <div class="content-area">
        
        
        <div id="tab-dashboard" class="tool-panel active">
          <h2>Overview</h2>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-val" id="statTables">0</div>
              <div class="stat-title">Total Tables</div>
            </div>
            <div class="stat-card">
              <div class="stat-val" id="statQueries">0</div>
              <div class="stat-title">Queries Executed</div>
            </div>
            <div class="stat-card">
              <div class="stat-val" style="color: var(--success);">OK</div>
              <div class="stat-title">System Status</div>
            </div>
          </div>

          <div class="card">
            <h3>Storage Utilization</h3>
            <div class="chart-container">
              <div class="chart-col" style="height: 30%;"><span>Users</span></div>
              <div class="chart-col" style="height: 65%;"><span>Transactions</span></div>
              <div class="chart-col" style="height: 45%;"><span>Logs</span></div>
              <div class="chart-col" style="height: 20%;"><span>Cache</span></div>
              <div class="chart-col" style="height: 80%;"><span>Products</span></div>
            </div>
          </div>
        </div>

        <div id="tab-database" class="tool-panel">
          <h2>Database Management</h2>
          <div class="card">
            <h3>Switch Database (USE)</h3>
            <div style="display: flex; gap: 10px;">
              <input type="text" id="useDbName" placeholder="Enter database name (e.g., kampus)">
              <button onclick="doUseDB()" class="btn-primary">Switch</button>
            </div>
            <div id="useDbAlert"></div>
          </div>

          <div class="card">
            <h3>Create New Database</h3>
            <div style="display: flex; gap: 10px;">
              <input type="text" id="newDbName" placeholder="New database name">
              <button onclick="doCreateDB()" class="btn-primary" style="background-color: var(--success);">Create</button>
            </div>
            <div id="createDbAlert"></div>
          </div>
        </div>

        <div id="tab-query" class="tool-panel">
          <h2>Query Console</h2>
          <div class="query-layout">
            <div style="display: flex; flex-direction: column;">
              <textarea id="queryInput" class="editor-box" style="height: 200px; border-radius: 8px 8px 0 0;" placeholder="Type your MaungQL query here..."></textarea>
              <button onclick="runQuery()" class="btn-primary" style="border-radius: 0 0 8px 8px;">‚ñ∂ Execute Query</button>
              
              <div id="queryOutput" style="margin-top: 20px;"></div>
            </div>

         
            <div class="syntax-card">
              <h4 style="margin-top: 0; color: var(--primary);">üêØ Kamus MaungQL v2.2 (Enterprise)</h4>
              
              <div class="syntax-item"><span class="code-pill">DAMEL &lt;tbl&gt; &lt;cols&gt;</span><div style="font-size: 0.85rem; color: var(--text-muted);">Create Table</div></div>
              <div class="syntax-item"><span class="code-pill">SIMPEN &lt;tbl&gt; val|val</span><div style="font-size: 0.85rem; color: var(--text-muted);">Insert Data</div></div>
              <div class="syntax-item"><span class="code-pill">TINGALI &lt;tbl&gt;</span><div style="font-size: 0.85rem; color: var(--text-muted);">Select all Column from Selected Table</div></div>
              <div class="syntax-item"><span class="code-pill">TINGALI &lt;cols&gt; TI &lt;tbl&gt;</span><div style="font-size: 0.85rem; color: var(--text-muted);">Select Column from Selected Table</div></div>
              <div class="syntax-item"><span class="code-pill">OMEAN &lt;tbl&gt; JADI c=v</span><div style="font-size: 0.85rem; color: var(--text-muted);">Update Data</div></div>
              <div class="syntax-item"><span class="code-pill">MICEUN TI &lt;tbl&gt;</span><div style="font-size: 0.85rem; color: var(--text-muted);">Delete Data</div></div>

              <h5 style="margin:10px 0 5px 0; color:var(--primary); font-size:0.85rem;">üîç Filter & Logika</h5>
              <div class="syntax-item"><span class="code-pill">DIMANA col = val</span><div style="font-size: 0.85rem; color: var(--text-muted);">Condition (Where)</div></div>
              <div class="syntax-item"><span class="code-pill">SARENG / ATAWA</span><div style="font-size: 0.85rem; color: var(--text-muted);">AND / OR Logic</div></div>
              <div class="syntax-item"><span class="code-pill">JIGA val</span><div style="font-size: 0.85rem; color: var(--text-muted);">Like / Search</div></div>
            
              <h5 style="margin:10px 0 5px 0; color:#8b5cf6; font-size:0.85rem;">üîó Relasi Tabel (JOIN) </h5>
              <div class="syntax-item"><span class="code-pill">GABUNG &lt;tbl2&gt; DINA...</span><div style="font-size: 0.85rem; color: var(--text-muted);">Inner Join (Alias: GABUNG/JOIN/HIJIKEUN)</div></div>
              <div class="syntax-item"><span class="code-pill">KENCA GABUNG &lt;tbl2&gt;</span><div style="font-size: 0.85rem; color: var(--text-muted);">Left Join (Data kiri wajib ada)</div></div>
              <div class="syntax-item"><span class="code-pill">KATUHU GABUNG &lt;tbl2&gt;</span><div style="font-size: 0.85rem; color: var(--text-muted);">Right Join (Data kanan wajib ada)</div></div>
              <div class="syntax-item"><span class="code-pill">... DINA t1.id = t2.id</span><div style="font-size: 0.85rem; color: var(--text-muted);">Kondisi Join (ON)</div></div>
              <div class="syntax-item"><span class="code-pill">FULL / PINUH</span><div style="font-size: 0.85rem; color: var(--text-muted);">(Optional) For Support Full Outer</div></div>

              <h5 style="margin:10px 0 5px 0; color:var(--primary); font-size:0.85rem;">‚ö° Pengatur Data</h5>
              <div class="syntax-item"><span class="code-pill">RUNTUYKEUN &lt;col&gt;</span><div style="font-size: 0.85rem; color: var(--text-muted);">Order By (TI_LUHUR / TI_HANDAP / NAEK / TURUN)</div></div>
              <div class="syntax-item"><span class="code-pill">SAKADAR &lt;n&gt;</span><div style="font-size: 0.85rem; color: var(--text-muted);">Limit Rows</div></div>
              <div class="syntax-item"><span class="code-pill">LIWATAN &lt;n&gt;</span><div style="font-size: 0.85rem; color: var(--text-muted);">Offset Rows</div></div>

              <h5 style="margin:10px 0 5px 0; color:var(--success); font-size:0.85rem;">üßÆ Aritmatika</h5>
              <div class="syntax-item"><span class="code-pill">JUMLAH()</span><div style="font-size: 0.85rem; color: var(--text-muted);">Count Rows</div></div>
              <div class="syntax-item"><span class="code-pill">RATA(col)</span><div style="font-size: 0.85rem; color: var(--text-muted);">Average (Rata-rata)</div></div>
              <div class="syntax-item"><span class="code-pill">TOTAL(col)</span><div style="font-size: 0.85rem; color: var(--text-muted);">Sum (Total)</div></div>
              <div class="syntax-item"><span class="code-pill">PANGGEDENA(col)</span><div style="font-size: 0.85rem; color: var(--text-muted);">Max Value</div></div>
              <div class="syntax-item"><span class="code-pill">PANGLEUTIKNA(col)</span><div style="font-size: 0.85rem; color: var(--text-muted);">Min Value</div></div>

              <h5 style="margin: 15px 0 10px 0; color: var(--primary); border-top: 1px dashed var(--border); padding-top: 10px;">
                üß™ Test Case 1: Single Table
              </h5>

              <div class="syntax-item">
                <div style="font-size: 0.75rem; font-weight: 600; color: var(--danger); margin-bottom: 4px;">0. Reset (Hapus Tabel Lama)</div>
                <div class="code-pill" style="cursor: pointer; font-size: 0.75rem; border:1px solid #fecaca; background:#fee2e2; color:#b91c1c;" onclick="copyToQuery('MICEUN TI pegawai')">MICEUN TI pegawai</div>
                <div style="font-size: 0.7rem; color: var(--text-muted); margin-top:2px; font-style:italic;">*Klik ini dulu jika tabel 'pegawai' sudah ada</div>
              </div>

              <div class="syntax-item">
                <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-main); margin-bottom: 4px;">1. Setup Tabel Lengkap</div>
                <div class="code-pill" style="cursor: pointer; font-size: 0.75rem; background-color: #fff7ed; color: #c2410c; border: 1px solid #fdba74;" onclick="copyToQuery('DAMEL pegawai id:INT,nama:STRING,kelamin:ENUM(PRIA,WANITA),divisi:ENUM(IT,HRD,MKT),gaji:FLOAT,masuk:DATE')">DAMEL pegawai id:INT,nama:STRING,kelamin:ENUM(PRIA,WANITA),divisi:ENUM(IT,HRD,MKT),gaji:FLOAT,masuk:DATE</div>
              </div>

              <div class="syntax-item">
                <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-main); margin-bottom: 4px;">2. Isi Data (Full Command)</div>
                <div class="code-pill" style="cursor: pointer; font-size: 0.75rem;" onclick="copyToQuery(this.innerText)">SIMPEN pegawai 101|Asep|PRIA|IT|5000000|2023-01-10</div>
                <div class="code-pill" style="cursor: pointer; font-size: 0.75rem; margin-top:2px;" onclick="copyToQuery(this.innerText)">SIMPEN pegawai 102|Budi|PRIA|HRD|38468000|2023-02-20</div>
                <div class="code-pill" style="cursor: pointer; font-size: 0.75rem; margin-top:2px;" onclick="copyToQuery(this.innerText)">SIMPEN pegawai 103|Cici|WANITA|IT|89736578|2023-03-05</div>
                <div class="code-pill" style="cursor: pointer; font-size: 0.75rem; margin-top:2px;" onclick="copyToQuery(this.innerText)">SIMPEN pegawai 104|Dedi|PRIA|MKT|678299876|2023-04-12</div>
              </div>

              <div class="syntax-item">
                <div style="font-size: 0.75rem; font-weight: 600; color: var(--success); margin-bottom: 4px;">3. Test Hitung Gaji</div>
                <div class="code-pill" style="cursor: pointer; font-size: 0.75rem;" onclick="copyToQuery(this.innerText)">TINGALI RATA(gaji), TOTAL(gaji), PANGGEDENA(gaji) TI pegawai</div>
              </div>

              <div class="syntax-item">
                <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-main); margin-bottom: 4px;">4. Pilih Kolom & Urutkan</div>
                <div class="code-pill" style="cursor: pointer; font-size: 0.75rem;" onclick="copyToQuery(this.innerText)">TINGALI nama,gaji,divisi TI pegawai RUNTUYKEUN gaji TI_LUHUR</div>
              </div>

              <div class="syntax-item">
                <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-main); margin-bottom: 4px;">5. Filter Logic (AND/OR)</div>
                <div class="code-pill" style="cursor: pointer; font-size: 0.75rem;" onclick="copyToQuery(this.innerText)">TINGALI pegawai DIMANA divisi = IT SARENG gaji > 5000000</div>
              </div>

              <div class="syntax-item">
                <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-main); margin-bottom: 4px;">6. Update & Delete</div>
                <div class="code-pill" style="cursor: pointer; font-size: 0.75rem;" onclick="copyToQuery(this.innerText)">OMEAN pegawai JADI gaji=8500000 DIMANA nama = Cici</div>
                <div class="code-pill" style="cursor: pointer; font-size: 0.75rem; margin-top:2px;" onclick="copyToQuery(this.innerText)">MICEUN TI pegawai DIMANA id = 104</div>
              </div>

              <h5 style="margin: 15px 0 10px 0; color: var(--primary); border-top: 1px dashed var(--border); padding-top: 10px;">
                üß™ Skenario Relasi (Divisi & Karyawan)
              </h5>

              <div class="syntax-item">
                <div style="font-size: 0.75rem; font-weight: 600; color: var(--danger); margin-bottom: 4px;">0. Reset (Hapus Tabel Lama)</div>
                <div class="code-pill" style="cursor: pointer; font-size: 0.75rem; border:1px solid #fecaca; background:#fee2e2; color:#b91c1c;" onclick="copyToQuery('MICEUN TI karyawan')">MICEUN TI karyawan</div>
                <div class="code-pill" style="cursor: pointer; font-size: 0.75rem; border:1px solid #fecaca; background:#fee2e2; color:#b91c1c; margin-top:2px;" onclick="copyToQuery('MICEUN TI divisi')">MICEUN TI divisi</div>
              </div>

              <div class="syntax-item">
                <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-main); margin-bottom: 4px;">1. Buat Tabel Relasi</div>
                <div class="code-pill" style="cursor: pointer; font-size: 0.75rem; background-color: #fff7ed; color: #c2410c; border: 1px solid #fdba74;" onclick="copyToQuery('DAMEL divisi id:INT,nama_divisi:STRING')">DAMEL divisi id:INT,nama_divisi:STRING</div>
                <div class="code-pill" style="cursor: pointer; font-size: 0.75rem; background-color: #fff7ed; color: #c2410c; border: 1px solid #fdba74; margin-top:2px;" onclick="copyToQuery('DAMEL karyawan id:INT,nama:STRING,id_divisi:INT,gaji:FLOAT')">DAMEL karyawan id:INT,nama:STRING,id_divisi:INT,gaji:FLOAT</div>
              </div>

              <div class="syntax-item">
                <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-main); margin-bottom: 4px;">2. Isi Data (Full Command)</div>
                <div class="code-pill" style="cursor: pointer; font-size: 0.75rem;" onclick="copyToQuery(this.innerText)">SIMPEN divisi 1|Teknologi</div>
                <div class="code-pill" style="cursor: pointer; font-size: 0.75rem; margin-top:2px;" onclick="copyToQuery(this.innerText)">SIMPEN divisi 2|Marketing</div>
                <div class="code-pill" style="cursor: pointer; font-size: 0.75rem; margin-top:5px;" onclick="copyToQuery(this.innerText)">SIMPEN karyawan 101|Asep|1|5000000</div>
                <div class="code-pill" style="cursor: pointer; font-size: 0.75rem; margin-top:2px;" onclick="copyToQuery(this.innerText)">SIMPEN karyawan 102|Siti|2|4500000</div>
                <div class="code-pill" style="cursor: pointer; font-size: 0.75rem; margin-top:2px;" onclick="copyToQuery(this.innerText)">SIMPEN karyawan 103|Budi|99|4000000</div>
              </div>

              <div class="syntax-item">
                <div style="font-size: 0.75rem; font-weight: 600; color: #8b5cf6; margin-bottom: 4px;">3. Test JOIN (Gabung)</div>
                
                <div style="font-size: 0.7rem; color: var(--text-muted);">Inner Join (Hanya yang cocok):</div>
                <div class="code-pill" style="cursor: pointer; font-size: 0.75rem; border-color:#8b5cf6; color:#5b21b6; background:#f5f3ff;" onclick="copyToQuery('TINGALI karyawan.nama, divisi.nama_divisi TI karyawan GABUNG divisi DINA karyawan.id_divisi = divisi.id')">TINGALI karyawan.nama, divisi.nama_divisi TI karyawan GABUNG divisi DINA karyawan.id_divisi = divisi.id</div>

                <div style="font-size: 0.7rem; color: var(--text-muted); margin-top:5px;">Left Join (Semua Karyawan + Divisi):</div>
                <div class="code-pill" style="cursor: pointer; font-size: 0.75rem; border-color:#8b5cf6; color:#5b21b6; background:#f5f3ff;" onclick="copyToQuery('TINGALI karyawan.nama, divisi.nama_divisi TI karyawan KENCA GABUNG divisi DINA karyawan.id_divisi = divisi.id')">TINGALI karyawan.nama, divisi.nama_divisi TI karyawan KENCA GABUNG divisi DINA karyawan.id_divisi = divisi.id</div>
              </div>

              <div class="syntax-item">
                <div style="font-size: 0.75rem; font-weight: 600; color: var(--success); margin-bottom: 4px;">4. Test Agregasi</div>
                <div class="code-pill" style="cursor: pointer; font-size: 0.75rem;" onclick="copyToQuery('TINGALI RATA(gaji), TOTAL(gaji) TI karyawan')">TINGALI RATA(gaji), TOTAL(gaji) TI karyawan</div>
              </div>

              <h5 style="margin: 15px 0 10px 0; color: #ef4444; border-top: 1px dashed var(--border); padding-top: 10px;">
                üëÆ‚Äç‚ôÇÔ∏è Test Case 3: Constraint Engine (RDBMS)
              </h5>

              <div class="syntax-item">
                <div style="font-size: 0.75rem; font-weight: 600; color: var(--danger); margin-bottom: 4px;">0. Reset</div>
                <div class="code-pill" style="cursor: pointer; font-size: 0.75rem; border:1px solid #fecaca; background:#fee2e2; color:#b91c1c;" onclick="copyToQuery('MICEUN TI siswa')">MICEUN TI siswa</div>
                <div class="code-pill" style="cursor: pointer; font-size: 0.75rem; border:1px solid #fecaca; background:#fee2e2; color:#b91c1c; margin-top:2px;" onclick="copyToQuery('MICEUN TI kelas')">MICEUN TI kelas</div>
              </div>

              <div class="syntax-item">
                <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-main); margin-bottom: 4px;">1. Setup Tabel (Constraint Penuh)</div>
                <div class="code-pill" style="cursor: pointer; font-size: 0.75rem; background-color: #fff7ed; color: #c2410c; border: 1px solid #fdba74;" onclick="copyToQuery('DAMEL kelas id:INT:PK,nama:STRING:UNIQUE')">DAMEL kelas id:INT:PK,nama:STRING:UNIQUE</div>
                <div class="code-pill" style="cursor: pointer; font-size: 0.75rem; background-color: #fff7ed; color: #c2410c; border: 1px solid #fdba74; margin-top:2px;" onclick="copyToQuery('DAMEL siswa nis:INT:PK,nama:STRING:NOT NULL,id_kelas:INT:FK(kelas.id)')">DAMEL siswa nis:INT:PK,nama:STRING:NOT NULL,id_kelas:INT:FK(kelas.id)</div>
              </div>

              <div class="syntax-item">
                <div style="font-size: 0.75rem; font-weight: 600; color: var(--success); margin-bottom: 4px;">2. Insert Data Valid (Sukses)</div>
                <div class="code-pill" style="cursor: pointer; font-size: 0.75rem;" onclick="copyToQuery('SIMPEN kelas 1|X-A')">SIMPEN kelas 1|X-A</div>
                <div class="code-pill" style="cursor: pointer; font-size: 0.75rem; margin-top:2px;" onclick="copyToQuery('SIMPEN kelas 2|X-B')">SIMPEN kelas 2|X-B</div>
                <div class="code-pill" style="cursor: pointer; font-size: 0.75rem; margin-top:2px;" onclick="copyToQuery('SIMPEN siswa 101|Udin|1')">SIMPEN siswa 101|Udin|1 (Masuk Kelas X-A)</div>
              </div>

              <div class="syntax-item">
                <div style="font-size: 0.75rem; font-weight: 600; color: var(--danger); margin-bottom: 4px;">3. Test ERROR (Harus Gagal!)</div>
                
                <div style="font-size: 0.7rem; color: var(--text-muted);">A. Duplicate PK (Kelas ID 1 sudah ada):</div>
                <div class="code-pill" style="cursor: pointer; font-size: 0.75rem; border-color:#f87171; color:#991b1b; background:#fef2f2;" onclick="copyToQuery('SIMPEN kelas 1|X-C')">SIMPEN kelas 1|X-C</div>

                <div style="font-size: 0.7rem; color: var(--text-muted); margin-top:5px;">B. Duplicate Unique (Nama 'X-A' sudah ada):</div>
                <div class="code-pill" style="cursor: pointer; font-size: 0.75rem; border-color:#f87171; color:#991b1b; background:#fef2f2;" onclick="copyToQuery('SIMPEN kelas 3|X-A')">SIMPEN kelas 3|X-A</div>

                <div style="font-size: 0.7rem; color: var(--text-muted); margin-top:5px;">C. Foreign Key Error (Kelas 99 tidak ada):</div>
                <div class="code-pill" style="cursor: pointer; font-size: 0.75rem; border-color:#f87171; color:#991b1b; background:#fef2f2;" onclick="copyToQuery('SIMPEN siswa 102|Bambang|99')">SIMPEN siswa 102|Bambang|99</div>

                <div style="font-size: 0.7rem; color: var(--text-muted); margin-top:5px;">D. Not Null Error (Nama kosong):</div>
                <div class="code-pill" style="cursor: pointer; font-size: 0.75rem; border-color:#f87171; color:#991b1b; background:#fef2f2;" onclick="copyToQuery('SIMPEN siswa 103|NULL|1')">SIMPEN siswa 103|NULL|1</div>
              </div>

            </div>
            
          </div>
        </div>

        <div id="tab-schema" class="tool-panel">
          <h2>Table Designer (RDBMS)</h2>
          <div class="card">
            <form onsubmit="event.preventDefault(); buildAndSubmitSchema();">
              <div class="form-group">
                <label>Table Name</label>
                <input type="text" id="builderTableName" placeholder="e.g. products" required style="font-size: 1rem; padding: 10px;">
              </div>

              <div style="margin-top: 20px;">
                <div class="schema-header">
                  <div>Column Name</div>
                  <div>Data Type</div>
                  <div>Constraints (PK / Unq / NN)</div>
                  <div>Foreign Key (Optional)</div>
                  <div></div>
                </div>

                <div id="columnsContainer"></div>
              </div>

              <button type="button" onclick="addNewColumnRow()" class="btn-add-row" style="margin-top:10px; width: 100%; border: 2px dashed #cbd5e1; background: #f8fafc; color: var(--text-muted);">+ Add New Column</button>
              
              <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">

              <button type="submit" class="btn-primary" style="width: 100%; padding: 12px; font-size: 1rem;">üöÄ Create Table</button>
            </form>
            <div id="schemaBuilderAlert"></div>
          </div>
          
          <div id="insertDataContainer" class="insert-container"></div>
          </div>
      </div>

      </div>
    </div>
  </div>

  <script src="/public/js/api.js"></script>
  <script src="/public/js/db.js"></script>
  <script src="/public/js/query.js"></script>
  <script src="/public/js/auth.js"></script>
  <script src="/public/js/ai-assistant.js"></script>
  
  <script>
    function saveState(key, value) { localStorage.setItem(key, value); }
    function loadState(key) { return localStorage.getItem(key); }

    function toggleSidebar() {
      document.querySelector('.sidebar').classList.toggle('open');
      document.querySelector('.overlay').classList.toggle('active');
    }

    function switchTab(tabName) {
      if(window.innerWidth <= 768) toggleSidebar();
      document.querySelectorAll('.tool-panel').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      document.getElementById('tab-' + tabName).classList.add('active');
      const index = ['dashboard', 'database', 'query', 'schema'].indexOf(tabName);
      if(index >= 0) document.querySelectorAll('.nav-item')[index].classList.add('active');
    }

    window.onload = async () => {
      const msg = await whoami();
      if(msg) {
        document.getElementById('userName').innerText = "Admin"; 
        document.getElementById('userRole').innerText = msg;
        const colors = ['#f59e0b', '#10b981', '#6366f1', '#ec4899'];
        document.querySelector('.user-avatar').style.background = colors[Math.floor(Math.random() * colors.length)];
      }

      const lastDB = loadState('maung_active_db');
      if (lastDB && lastDB !== 'null') {
        document.getElementById('dbIndicator').classList.add('active');
        document.getElementById('activeDBName').innerText = lastDB;
        try { await API.post("/db/use", { database: lastDB }); } catch (e) {}
      }
      document.getElementById('statTables').innerText = loadState('maung_stat_tables') || 0;
      document.getElementById('statQueries').innerText = loadState('maung_stat_queries') || 0;
      
      document.querySelectorAll('.chart-col').forEach(col => {
        col.style.height = (Math.floor(Math.random() * 60) + 20) + '%';
      });
   
            addNewColumnRow();
    };

    const originalRunQuery = window.runQuery;
    window.runQuery = async function() {
      await originalRunQuery();
      let newCount = parseInt(document.getElementById('statQueries').innerText) + 1;
      document.getElementById('statQueries').innerText = newCount;
      saveState('maung_stat_queries', newCount);
    }

    const originalDoUseDB = window.doUseDB;
    window.doUseDB = async function() {
      await originalDoUseDB();
      const currentDB = document.getElementById('activeDBName').innerText;
      if (currentDB && currentDB !== 'No Database Selected' && currentDB !== 'Belum dipilih') {
        saveState('maung_active_db', currentDB);
      }
    }



 function addNewColumnRow() {
      const container = document.getElementById('columnsContainer');
      const div = document.createElement('div');
      div.className = 'col-row';
      
      const ts = Date.now() + Math.random().toString(36).substr(2, 5); 

      div.innerHTML = `
        <input type="text" placeholder="col_name" class="col-name" required autocomplete="off">
        
        <div style="display:flex; gap:5px; flex-direction:column;">
            <select class="col-type" onchange="handleTypeChange(this)">
            <option value="int">INT</option>
            <option value="string">STRING</option>
            <option value="float">FLOAT</option>
            <option value="bool">BOOL</option>
            <option value="date">DATE</option>
            <option value="text">TEXT</option>
            <option value="enum">ENUM</option>
            <option value="char">CHAR</option>
            </select>
            <input type="text" class="col-args" placeholder="A,B,C" style="display: none; font-size:0.75rem;">
        </div>

        <div class="constraint-group">
            <label title="Primary Key">
                <input type="checkbox" class="chk-hidden chk-pk" id="pk_${ts}" onchange="handlePKChange(this)">
                <div class="chk-btn pk-btn">PK</div>
            </label>

            <label title="Unique (Tidak boleh kembar)">
                <input type="checkbox" class="chk-hidden chk-unique" id="unq_${ts}">
                <div class="chk-btn">Unq</div>
            </label>

            <label title="Not Null (Wajib isi)">
                <input type="checkbox" class="chk-hidden chk-nn" id="nn_${ts}">
                <div class="chk-btn">NN</div>
            </label>
        </div>

        <input type="text" class="fk-input" placeholder="tabel.id" title="Foreign Key (Contoh: kelas.id)">

        <button type="button" class="btn-remove" onclick="this.parentElement.remove()">√ó</button>
      `;
      container.appendChild(div);
    }
 
    function handleTypeChange(selectElem) {
        const row = selectElem.parentElement;
        const argsInput = row.querySelector('.col-args');
        const val = selectElem.value;
        
        if (val === 'enum') {
            argsInput.style.display = 'block';
            argsInput.placeholder = 'Pria,Wanita';
            argsInput.required = true;
        } else if (val === 'char') {
            argsInput.style.display = 'block';
            argsInput.placeholder = 'Length (e.g. 10)';
            argsInput.required = true;
        } else {
            argsInput.style.display = 'none';
            argsInput.required = false;
        }
    }


    function handlePKChange(chkPK) {
        const row = chkPK.closest('.col-row');
        const chkUnq = row.querySelector('.chk-unique');
        const chkNN = row.querySelector('.chk-nn');
        
        if (chkPK.checked) {
            chkUnq.checked = true;
            chkNN.checked = true;
            
            chkUnq.disabled = true;
            chkNN.disabled = true;
        } else {
            chkUnq.disabled = false;
            chkNN.disabled = false;
            
            chkUnq.checked = false;
            chkNN.checked = false;
        }
    }

    async function buildAndSubmitSchema() {
      const tableName = document.getElementById('builderTableName').value;
      const rows = document.querySelectorAll('.col-row');
      const alertBox = document.getElementById('schemaBuilderAlert');
      
      let fieldsArray = [];
      let isValid = true;

      rows.forEach(row => {
        const name = row.querySelector('.col-name').value;
        const type = row.querySelector('.col-type').value;
        const args = row.querySelector('.col-args').value; 
        const isPK = row.querySelector('.chk-pk').checked;
        const isUnique = row.querySelector('.chk-unique').checked;
        const isNN = row.querySelector('.chk-nn').checked;
        const fkVal = row.querySelector('.fk-input').value.trim();

        if(name) {
            let def = `${name}:${type}`;

            if (type === 'enum' || type === 'char') {
                if (!args) {
                    alert('Harap isi detail untuk kolom ' + name + ' (' + type + ')');
                    isValid = false;
                    return;
                }
                def += `(${args})`;
            }

            if (isPK) def += ":PK";
            else {
                if (isUnique) def += ":UNIQUE";
                if (isNN) def += ":NOT NULL";
            }

            if (fkVal) def += `:FK(${fkVal})`;

            fieldsArray.push(def);
        }
      });

      if(!isValid) return;

      console.log("Sending Schema:", fieldsArray);

      const res = await API.post("/schema/create", { table: tableName, fields: fieldsArray });

      if (res.success) {
        alertBox.innerHTML = `<div class="alert alert-success">‚úÖ Table <b>${tableName}</b> created with constraints!</div>`;
        let count = parseInt(document.getElementById('statTables').innerText) + 1;
        document.getElementById('statTables').innerText = count;
        saveState('maung_stat_tables', count);
        
        generateInsertForm(tableName, fieldsArray);
      } else {
        alertBox.innerHTML = `<div class="alert alert-error">‚ùå ${res.error}</div>`;
        document.getElementById('insertDataContainer').style.display = 'none';
      }
    }

    function generateInsertForm(tableName, fields) {
      const container = document.getElementById('insertDataContainer');
      container.style.display = 'block'; 
      
      let inputsHtml = '';
      fields.forEach((field) => {

        const parts = field.split(':');
        const colName = parts[0];
        const colTypeFull = parts[1].toUpperCase(); 
        
        let inputHtml = '';

        if (colTypeFull.startsWith('ENUM')) {
            const content = colTypeFull.substring(colTypeFull.indexOf('(') + 1, colTypeFull.lastIndexOf(')'));
            const options = content.split(',');
            let opts = options.map(o => `<option value="${o}">${o}</option>`).join('');
            inputHtml = `<select class="insert-input" required>${opts}</select>`;
        
        } else if (colTypeFull === 'BOOL') {
            inputHtml = `<select class="insert-input" required><option value="true">True</option><option value="false">False</option></select>`;
        
        } else if (colTypeFull === 'DATE') {
            inputHtml = `<input type="date" class="insert-input" required>`;
        
        } else if (colTypeFull === 'INT' || colTypeFull === 'FLOAT') {
            inputHtml = `<input type="number" step="any" class="insert-input" placeholder="0" required>`;
        
        } else {
            inputHtml = `<input type="text" class="insert-input" placeholder="..." required>`;
        }

        inputsHtml += `
          <div class="form-group">
            <label style="font-size:0.85rem; color:var(--text-muted);">
                ${colName} <span class="type-badge">${colTypeFull.split('(')[0]}</span>
            </label>
            ${inputHtml}
          </div>
        `;
      });

      container.innerHTML = `
        <h3 style="color:var(--primary); margin-bottom:15px;">Insert Data into '${tableName}'</h3>
        <form onsubmit="event.preventDefault(); submitInsertData('${tableName}');">
          <div class="insert-grid">${inputsHtml}</div>
          <button type="submit" class="btn-primary" style="margin-top: 20px; width: 100%; background-color: var(--success);">+ Insert Row</button>
        </form>
        <div id="insertResult"></div>
      `;
    }

    async function submitInsertData(tableName) {
       const inputs = document.querySelectorAll('.insert-input');
       const values = Array.from(inputs).map(input => input.value);
       const dataString = values.join('|');
       const query = `simpen ${tableName} ${dataString}`;
       
       const resultDiv = document.getElementById('insertResult');
       resultDiv.innerHTML = '<div style="margin-top:10px; color:var(--text-muted);">‚è≥ Inserting...</div>';
       
       const res = await API.post("/query", { query: query });
       
       if(res.success) {
          resultDiv.innerHTML = `<div class="alert alert-success">‚úÖ Data inserted!</div>`;
          inputs.forEach(input => {
              if(input.tagName === 'SELECT') input.selectedIndex = 0;
              else input.value = '';
          });
          let newCount = parseInt(document.getElementById('statQueries').innerText) + 1;
          document.getElementById('statQueries').innerText = newCount;
          saveState('maung_stat_queries', newCount);
       } else {
          resultDiv.innerHTML = `<div class="alert alert-error">‚ùå ${res.error}</div>`;
       }
    }
    function doExport() {
        const table = document.getElementById('exportTableName').value;
        if(!table) { alert("Please enter table name!"); return; }
        

        window.location.href = `/db/export?table=${table}`;
    }

    async function doImport() {
        const table = document.getElementById('importTableName').value;
        const fileInput = document.getElementById('importFile');
        const alertBox = document.getElementById('migrationAlert');

        if(!table || fileInput.files.length === 0) { return; }

        const formData = new FormData();
        formData.append("table", table);
        formData.append("csv_file", fileInput.files[0]);

        alertBox.innerHTML = '<div style="color:blue;">‚è≥ Uploading & Processing...</div>';

        try {
            const raw = await fetch('/db/import', {
                method: 'POST',
                body: formData
            });
            const res = await raw.json();

            if(res.success) {
                alertBox.innerHTML = `<div class="alert alert-success">${res.message}</div>`;
                let newCount = parseInt(document.getElementById('statTables').innerText); 
            } else {
                alertBox.innerHTML = `<div class="alert alert-error">‚ùå ${res.error}</div>`;
            }
        } catch(e) {
            alertBox.innerHTML = `<div class="alert alert-error">‚ùå Connection Error</div>`;
        }
    }

  </script>
</body>
</html>