<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MaungDB Studio</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/static/css/style_main.css" />


  
</head>
<body>

  <div class="overlay" onclick="toggleSidebar()"></div>

  <div class="app-layout">
    
    <aside class="sidebar">
      <div class="sidebar-header">
        <span style="margin-right: 10px;">üêØ</span> MaungDB Studio
      </div>

      <div class="user-profile">
        <div class="user-avatar">M</div>
        <div class="user-name" id="userName">User</div>
        <div class="user-role" id="userRole">Connecting...</div>
      </div>

      <nav class="nav-menu">
        <div class="nav-item active" onclick="switchTab('dashboard')">
          <span>üìä</span> Dashboard
        </div>
        <div class="nav-item" onclick="switchTab('database')">
          <span>üóÑÔ∏è</span> Database Manager
        </div>
        <div class="nav-item" onclick="switchTab('query')">
          <span>‚ö°</span> Query Console
        </div>
        <div class="nav-item" onclick="switchTab('schema')">
          <span>üìê</span> Table Designer
        </div>
      </nav>

      <div class="sidebar-footer">
        <button onclick="logout()" class="btn-logout">Sign Out</button>
      </div>
    </aside>

    <div class="main-wrapper">
      
      <header class="top-header">
        <div class="header-left">
          <button class="menu-btn" onclick="toggleSidebar()">‚ò∞</button>
          <div class="db-badge">
            <div class="dot" id="dbIndicator"></div>
            <span id="activeDBName">No Database Selected</span>
          </div>
        </div>
        <div class="server-version">
          Server v1.0.0
        </div>
      </header>

      <div class="content-area">
        
        <div id="tab-dashboard" class="tool-panel active">
          <h2>Overview</h2>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-val" id="statTables">0</div>
              <div class="stat-title">Total Tables</div>
            </div>
            <div class="stat-card">
              <div class="stat-val" id="statQueries">0</div>
              <div class="stat-title">Queries Executed</div>
            </div>
            <div class="stat-card">
              <div class="stat-val" style="color: var(--success);">OK</div>
              <div class="stat-title">System Status</div>
            </div>
          </div>

          <div class="card">
            <h3>Storage Utilization</h3>
            <div class="chart-container">
              <div class="chart-col" style="height: 30%;"><span>Users</span></div>
              <div class="chart-col" style="height: 65%;"><span>Transactions</span></div>
              <div class="chart-col" style="height: 45%;"><span>Logs</span></div>
              <div class="chart-col" style="height: 20%;"><span>Cache</span></div>
              <div class="chart-col" style="height: 80%;"><span>Products</span></div>
            </div>
          </div>
        </div>

        <div id="tab-database" class="tool-panel">
          <h2>Database Management</h2>
          <div class="card">
            <h3>Switch Database (USE)</h3>
            <div style="display: flex; gap: 10px;">
              <input type="text" id="useDbName" placeholder="Enter database name (e.g., kampus)">
              <button onclick="doUseDB()" class="btn-primary">Switch</button>
            </div>
            <div id="useDbAlert"></div>
          </div>

          <div class="card">
            <h3>Create New Database</h3>
            <div style="display: flex; gap: 10px;">
              <input type="text" id="newDbName" placeholder="New database name">
              <button onclick="doCreateDB()" class="btn-primary" style="background-color: var(--success);">Create</button>
            </div>
            <div id="createDbAlert"></div>
          </div>
        </div>

        <div id="tab-query" class="tool-panel">
          <h2>Query Console</h2>
          <div class="query-layout">
            <div style="display: flex; flex-direction: column;">
              <textarea id="queryInput" class="editor-box" style="height: 200px; border-radius: 8px 8px 0 0;" placeholder="Type your MaungQL query here..."></textarea>
              <button onclick="runQuery()" class="btn-primary" style="border-radius: 0 0 8px 8px;">‚ñ∂ Execute Query</button>
              
              <div id="queryOutput" style="margin-top: 20px;"></div>
            </div>

         
            <div class="syntax-card">
              <h4 style="margin-top: 0; color: var(--primary);">üêØ Kamus MaungQL v2.2 (Enterprise)</h4>
              
              <div class="syntax-item"><span class="code-pill">DAMEL &lt;tbl&gt; &lt;cols&gt;</span><div style="font-size: 0.85rem; color: var(--text-muted);">Create Table</div></div>
              <div class="syntax-item"><span class="code-pill">SIMPEN &lt;tbl&gt; val|val</span><div style="font-size: 0.85rem; color: var(--text-muted);">Insert Data</div></div>
              <div class="syntax-item"><span class="code-pill">TINGALI &lt;tbl&gt;</span><div style="font-size: 0.85rem; color: var(--text-muted);">Select all Column from Selected Table</div></div>
              <div class="syntax-item"><span class="code-pill">TINGALI &lt;cols&gt; TI &lt;tbl&gt;</span><div style="font-size: 0.85rem; color: var(--text-muted);">Select Data</div></div>
              <div class="syntax-item"><span class="code-pill">OMEAN &lt;tbl&gt; JANTEN c=v</span><div style="font-size: 0.85rem; color: var(--text-muted);">Update Data</div></div>
              <div class="syntax-item"><span class="code-pill">MICEUN TI &lt;tbl&gt;</span><div style="font-size: 0.85rem; color: var(--text-muted);">Delete Data</div></div>

              <h5 style="margin:10px 0 5px 0; color:#8b5cf6; font-size:0.85rem;">üîó Relasi Tabel (JOIN)</h5>
              <div class="syntax-item"><span class="code-pill">GABUNG &lt;tbl2&gt; DINA...</span><div style="font-size: 0.85rem; color: var(--text-muted);">Inner Join (Alias: HIJIKEUN)</div></div>
              <div class="syntax-item"><span class="code-pill">KENCA GABUNG &lt;tbl2&gt;</span><div style="font-size: 0.85rem; color: var(--text-muted);">Left Join (Data kiri wajib ada)</div></div>
              <div class="syntax-item"><span class="code-pill">KATUHU GABUNG &lt;tbl2&gt;</span><div style="font-size: 0.85rem; color: var(--text-muted);">Right Join (Data kanan wajib ada)</div></div>
              <div class="syntax-item"><span class="code-pill">... DINA t1.id = t2.id</span><div style="font-size: 0.85rem; color: var(--text-muted);">Kondisi Join (ON)</div></div>
              <div class="syntax-item"><span class="code-pill">PINUH GABUNG</span><div style="font-size: 0.85rem; color: var(--text-muted);">Full Outer Join (Optional)</div></div>

              <h5 style="margin:10px 0 5px 0; color:var(--primary); font-size:0.85rem;">üîç Filter & Logika</h5>
              <div class="syntax-item"><span class="code-pill">DIMANA col = val</span><div style="font-size: 0.85rem; color: var(--text-muted);">Condition</div></div>
              <div class="syntax-item"><span class="code-pill">SARENG / ATAWA</span><div style="font-size: 0.85rem; color: var(--text-muted);">AND / OR Logic</div></div>
              <div class="syntax-item"><span class="code-pill">JIGA val</span><div style="font-size: 0.85rem; color: var(--text-muted);">Like / Search</div></div>

              <h5 style="margin:10px 0 5px 0; color:var(--primary); font-size:0.85rem;">‚ö° Pengatur Data</h5>
              <div class="syntax-item"><span class="code-pill">RUNTUYKEUN &lt;col&gt;</span><div style="font-size: 0.85rem; color: var(--text-muted);">Order By (TI_LUHUR / NAEK)</div></div>
              <div class="syntax-item"><span class="code-pill">SAKADAR &lt;n&gt;</span><div style="font-size: 0.85rem; color: var(--text-muted);">Limit Rows</div></div>
              <div class="syntax-item"><span class="code-pill">LIWATAN &lt;n&gt;</span><div style="font-size: 0.85rem; color: var(--text-muted);">Offset Rows</div></div>

              <h5 style="margin:10px 0 5px 0; color:var(--success); font-size:0.85rem;">üßÆ Aritmatika</h5>
              <div class="syntax-item"><span class="code-pill">JUMLAH()</span><div style="font-size: 0.85rem; color: var(--text-muted);">Count Rows</div></div>
              <div class="syntax-item"><span class="code-pill">RATA(col)</span><div style="font-size: 0.85rem; color: var(--text-muted);">Average</div></div>
              <div class="syntax-item"><span class="code-pill">TOTAL(col)</span><div style="font-size: 0.85rem; color: var(--text-muted);">Sum</div></div>
              <div class="syntax-item"><span class="code-pill">PANGGEDENA(col)</span><div style="font-size: 0.85rem; color: var(--text-muted);">Max Value</div></div>
              <div class="syntax-item"><span class="code-pill">PANGLEUTIKNA(col)</span><div style="font-size: 0.85rem; color: var(--text-muted);">Min Value</div></div>

              <h5 style="margin: 15px 0 10px 0; color: var(--primary); border-top: 1px dashed var(--border); padding-top: 10px;">
                üß™ Test Case 1: Single Table
              </h5>

              <div class="syntax-item">
                <div style="font-size: 0.75rem; font-weight: 600; color: var(--danger); margin-bottom: 4px;">0. Reset (Hapus Tabel Lama)</div>
                <div class="code-pill" style="cursor: pointer; font-size: 0.75rem; border:1px solid #fecaca; background:#fee2e2; color:#b91c1c;" onclick="copyToQuery('MICEUN TI pegawai')">MICEUN TI pegawai</div>
              </div>

              <div class="syntax-item">
                <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-main); margin-bottom: 4px;">1. Setup Tabel</div>
                <div class="code-pill" style="cursor: pointer; font-size: 0.75rem; background-color: #fff7ed; color: #c2410c; border: 1px solid #fdba74;" onclick="copyToQuery(this.innerText)">DAMEL pegawai id:INT,nama:STRING,kelamin:ENUM(PRIA,WANITA),divisi:ENUM(IT,HRD,MKT),gaji:FLOAT,masuk:DATE</div>
              </div>

              <div class="syntax-item">
                <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-main); margin-bottom: 4px;">2. Isi Data (Single)</div>
                <div class="code-pill" style="cursor: pointer; font-size: 0.75rem;" onclick="copyToQuery(this.innerText)">SIMPEN pegawai 101|Asep|PRIA|IT|5000000|2023-01-10</div>
                <div class="code-pill" style="cursor: pointer; font-size: 0.75rem; margin-top:2px;" onclick="copyToQuery(this.innerText)">SIMPEN pegawai 102|Budi|PRIA|HRD|38468000|2023-02-20</div>
                <div class="code-pill" style="cursor: pointer; font-size: 0.75rem; margin-top:2px;" onclick="copyToQuery(this.innerText)">SIMPEN pegawai 103|Cici|WANITA|IT|89736578|2023-03-05</div>
                <div class="code-pill" style="cursor: pointer; font-size: 0.75rem; margin-top:2px;" onclick="copyToQuery(this.innerText)">SIMPEN pegawai 104|Dedi|PRIA|MKT|678299876|2023-04-12</div>
              </div>

              <div class="syntax-item">
                <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-main); margin-bottom: 4px;">3. Filter & Sort</div>
                <div class="code-pill" style="cursor: pointer; font-size: 0.75rem;" onclick="copyToQuery(this.innerText)">TINGALI pegawai DIMANA divisi = IT SARENG gaji > 5000000</div>
              </div>

              <h5 style="margin: 15px 0 10px 0; color: #8b5cf6; border-top: 1px dashed var(--border); padding-top: 10px;">
                üîó Test Case 2: Relasi (Divisi & Karyawan)
              </h5>

              <div class="syntax-item">
                <div style="font-size: 0.75rem; font-weight: 600; color: var(--danger); margin-bottom: 4px;">0. Reset (Hapus Tabel Lama)</div>
                <div class="code-pill" style="cursor: pointer; font-size: 0.75rem; border:1px solid #fecaca; background:#fee2e2; color:#b91c1c;" onclick="copyToQuery('MICEUN TI karyawan')">MICEUN TI karyawan</div>
                <div class="code-pill" style="cursor: pointer; font-size: 0.75rem; border:1px solid #fecaca; background:#fee2e2; color:#b91c1c; margin-top:2px;" onclick="copyToQuery('MICEUN TI divisi')">MICEUN TI divisi</div>
              </div>

              <div class="syntax-item">
                <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-main); margin-bottom: 4px;">1. Buat Tabel Relasi</div>
                <div class="code-pill" style="cursor: pointer; font-size: 0.75rem; background-color: #fff7ed; color: #c2410c; border: 1px solid #fdba74;" onclick="copyToQuery('DAMEL divisi id:INT,nama_divisi:STRING')">DAMEL divisi id:INT,nama_divisi:STRING</div>
                <div class="code-pill" style="cursor: pointer; font-size: 0.75rem; background-color: #fff7ed; color: #c2410c; border: 1px solid #fdba74; margin-top:2px;" onclick="copyToQuery('DAMEL karyawan id:INT,nama:STRING,id_divisi:INT,gaji:FLOAT')">DAMEL karyawan id:INT,nama:STRING,id_divisi:INT,gaji:FLOAT</div>
              </div>

              <div class="syntax-item">
                <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-main); margin-bottom: 4px;">2. Isi Data (Full Command)</div>
                <div class="code-pill" style="cursor: pointer; font-size: 0.75rem;" onclick="copyToQuery(this.innerText)">SIMPEN divisi 1|Teknologi</div>
                <div class="code-pill" style="cursor: pointer; font-size: 0.75rem; margin-top:2px;" onclick="copyToQuery(this.innerText)">SIMPEN divisi 2|Marketing</div>
                <div class="code-pill" style="cursor: pointer; font-size: 0.75rem; margin-top:5px;" onclick="copyToQuery(this.innerText)">SIMPEN karyawan 101|Asep|1|5000000</div>
                <div class="code-pill" style="cursor: pointer; font-size: 0.75rem; margin-top:2px;" onclick="copyToQuery(this.innerText)">SIMPEN karyawan 102|Siti|2|4500000</div>
                <div class="code-pill" style="cursor: pointer; font-size: 0.75rem; margin-top:2px;" onclick="copyToQuery(this.innerText)">SIMPEN karyawan 103|Budi|99|4000000</div>
              </div>

              <div class="syntax-item">
                <div style="font-size: 0.75rem; font-weight: 600; color: #8b5cf6; margin-bottom: 4px;">3. Test JOIN (Gabung)</div>
                
                <div style="font-size: 0.7rem; color: var(--text-muted);">Inner Join (Hanya yang cocok):</div>
                <div class="code-pill" style="cursor: pointer; font-size: 0.75rem; border-color:#8b5cf6; color:#5b21b6; background:#f5f3ff;" onclick="copyToQuery('TINGALI karyawan.nama, divisi.nama_divisi TI karyawan GABUNG divisi DINA karyawan.id_divisi = divisi.id')">TINGALI karyawan.nama, divisi.nama_divisi TI karyawan GABUNG divisi DINA karyawan.id_divisi = divisi.id</div>

                <div style="font-size: 0.7rem; color: var(--text-muted); margin-top:5px;">Left Join (Semua Karyawan + Divisi):</div>
                <div class="code-pill" style="cursor: pointer; font-size: 0.75rem; border-color:#8b5cf6; color:#5b21b6; background:#f5f3ff;" onclick="copyToQuery('TINGALI karyawan.nama, divisi.nama_divisi TI karyawan KENCA GABUNG divisi DINA karyawan.id_divisi = divisi.id')">TINGALI karyawan.nama, divisi.nama_divisi TI karyawan KENCA GABUNG divisi DINA karyawan.id_divisi = divisi.id</div>
              </div>

              <div class="syntax-item">
                <div style="font-size: 0.75rem; font-weight: 600; color: var(--success); margin-bottom: 4px;">4. Test Agregasi</div>
                <div class="code-pill" style="cursor: pointer; font-size: 0.75rem;" onclick="copyToQuery('TINGALI RATA(gaji), TOTAL(gaji) TI karyawan')">TINGALI RATA(gaji), TOTAL(gaji) TI karyawan</div>
              </div>

            </div>
            
          </div>
        </div>

        <div id="tab-schema" class="tool-panel">
          <h2>Table Designer</h2>
          <div class="card">
            <form onsubmit="event.preventDefault(); buildAndSubmitSchema();">
              <div class="form-group">
                <label>Table Name</label>
                <input type="text" id="builderTableName" placeholder="e.g. products" required>
              </div>

              <label style="display:block; margin-bottom: 10px; font-weight: 500;">Columns</label>
              
              <div id="columnsContainer">
                <div class="col-row">
                  <input type="text" placeholder="Name" class="col-name" required style="flex: 2;">
                  <select class="col-type" style="flex: 1;" onchange="handleTypeChange(this)">
                    <option value="int">INT (Angka)</option>
                    <option value="float">FLOAT (Desimal)</option>
                    <option value="string">STRING (Teks)</option>
                    <option value="text">TEXT (Panjang)</option>
                    <option value="bool">BOOL (T/F)</option>
                    <option value="date">DATE (Tanggal)</option>
                    <option value="enum">ENUM (Pilihan)</option>
                    <option value="char">CHAR (Fixed)</option>
                  </select>
                  <input type="text" class="col-args" placeholder="Detail..." style="flex: 1; display: none;">
                  <button type="button" class="btn-icon" disabled style="opacity: 0.5;">√ó</button>
                </div>
              </div>

              <button type="button" onclick="addNewColumnRow()" class="btn-add-row">+ Add Another Column</button>
              <button type="submit" class="btn-primary" style="width: 100%;">Create Table</button>
            </form>
            <div id="schemaBuilderAlert"></div>

            <div id="insertDataContainer" class="insert-container"></div>
            <div class="card" style="margin-top: 24px; border-top: 4px solid var(--warning);">
              <h3>üì¶ Data Migration (Import/Export)</h3>
              
              <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                  <div style="flex: 1; min-width: 250px;">
                      <h4 style="margin-top:0;">Export Table (Download CSV)</h4>
                      <div style="display: flex; gap: 10px;">
                          <input type="text" id="exportTableName" placeholder="Table name..." style="flex:1;">
                          <button onclick="doExport()" class="btn-primary" style="background: var(--text-sidebar);">‚¨á Export</button>
                      </div>
                  </div>

                  <div style="flex: 1; min-width: 250px;">
                      <h4 style="margin-top:0;">Import CSV (Upload)</h4>
                      <form onsubmit="event.preventDefault(); doImport();" style="display: flex; gap: 10px; flex-direction: column;">
                          <input type="text" id="importTableName" placeholder="Target Table name..." required>
                          <input type="file" id="importFile" accept=".csv" required style="background: white;">
                          <button type="submit" class="btn-primary" style="background: var(--warning); color: #000;">‚¨Ü Upload & Import</button>
                      </form>
                  </div>
              </div>
              <div id="migrationAlert" style="margin-top: 15px;"></div>
          </div>

          </div>
        </div>

      </div>
    </div>
  </div>

  <script src="/static/js/api.js"></script>
  <script src="/static/js/db.js"></script>
  <script src="/static/js/query.js"></script>
  <script src="/static/js/auth.js"></script>

  <script>
    // --- 1. PERSISTENCE HELPERS ---
    function saveState(key, value) { localStorage.setItem(key, value); }
    function loadState(key) { return localStorage.getItem(key); }

    // --- 2. UI LOGIC ---
    function toggleSidebar() {
      document.querySelector('.sidebar').classList.toggle('open');
      document.querySelector('.overlay').classList.toggle('active');
    }

    function switchTab(tabName) {
      if(window.innerWidth <= 768) toggleSidebar();
      document.querySelectorAll('.tool-panel').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      document.getElementById('tab-' + tabName).classList.add('active');
      const index = ['dashboard', 'database', 'query', 'schema'].indexOf(tabName);
      if(index >= 0) document.querySelectorAll('.nav-item')[index].classList.add('active');
    }

    window.onload = async () => {
      const msg = await whoami();
      if(msg) {
        document.getElementById('userName').innerText = "Admin"; 
        document.getElementById('userRole').innerText = msg;
        const colors = ['#f59e0b', '#10b981', '#6366f1', '#ec4899'];
        document.querySelector('.user-avatar').style.background = colors[Math.floor(Math.random() * colors.length)];
      }

      // Restore State
      const lastDB = loadState('maung_active_db');
      if (lastDB && lastDB !== 'null') {
        document.getElementById('dbIndicator').classList.add('active');
        document.getElementById('activeDBName').innerText = lastDB;
        try { await API.post("/db/use", { database: lastDB }); } catch (e) {}
      }
      document.getElementById('statTables').innerText = loadState('maung_stat_tables') || 0;
      document.getElementById('statQueries').innerText = loadState('maung_stat_queries') || 0;
      
      document.querySelectorAll('.chart-col').forEach(col => {
        col.style.height = (Math.floor(Math.random() * 60) + 20) + '%';
      });
    };

    const originalRunQuery = window.runQuery;
    window.runQuery = async function() {
      await originalRunQuery();
      let newCount = parseInt(document.getElementById('statQueries').innerText) + 1;
      document.getElementById('statQueries').innerText = newCount;
      saveState('maung_stat_queries', newCount);
    }

    const originalDoUseDB = window.doUseDB;
    window.doUseDB = async function() {
      await originalDoUseDB();
      const currentDB = document.getElementById('activeDBName').innerText;
      if (currentDB && currentDB !== 'No Database Selected' && currentDB !== 'Belum dipilih') {
        saveState('maung_active_db', currentDB);
      }
    }


    function addNewColumnRow() {
      const container = document.getElementById('columnsContainer');
      const div = document.createElement('div');
      div.className = 'col-row';
      div.innerHTML = `
        <input type="text" placeholder="Name" class="col-name" required style="flex: 2;">
        <select class="col-type" style="flex: 1;" onchange="handleTypeChange(this)">
          <option value="int">INT</option>
          <option value="float">FLOAT</option>
          <option value="string">STRING</option>
          <option value="text">TEXT</option>
          <option value="bool">BOOL</option>
          <option value="date">DATE</option>
          <option value="enum">ENUM</option>
          <option value="char">CHAR</option>
        </select>
        <input type="text" class="col-args" placeholder="Detail..." style="flex: 1; display: none;">
        <button type="button" class="btn-icon" onclick="this.parentElement.remove()">√ó</button>
      `;
      container.appendChild(div);
    }

    // Handle Tampilan Input Tambahan (Enum/Char)
    function handleTypeChange(selectElem) {
        const row = selectElem.parentElement;
        const argsInput = row.querySelector('.col-args');
        const val = selectElem.value;
        
        if (val === 'enum') {
            argsInput.style.display = 'block';
            argsInput.placeholder = 'Pria,Wanita';
            argsInput.required = true;
        } else if (val === 'char') {
            argsInput.style.display = 'block';
            argsInput.placeholder = 'Panjang (Cth: 5)';
            argsInput.required = true;
        } else {
            argsInput.style.display = 'none';
            argsInput.required = false;
            argsInput.value = '';
        }
    }

    async function buildAndSubmitSchema() {
      const tableName = document.getElementById('builderTableName').value;
      const rows = document.querySelectorAll('.col-row');
      const alertBox = document.getElementById('schemaBuilderAlert');
      
      let fieldsArray = [];
      let isValid = true;

      rows.forEach(row => {
        const name = row.querySelector('.col-name').value;
        const type = row.querySelector('.col-type').value;
        const args = row.querySelector('.col-args').value; // Ambil args
        
        if(name) {
            // Konstruksi Schema: name:ENUM(A,B) atawa name:INT
            if (type === 'enum' || type === 'char') {
                if (!args) {
                    alert('Harap isi detail untuk kolom ' + name + ' (' + type + ')');
                    isValid = false;
                    return;
                }
                fieldsArray.push(`${name}:${type}(${args})`);
            } else {
                fieldsArray.push(`${name}:${type}`);
            }
        }
      });

      if(!isValid) return;

      const res = await API.post("/schema/create", { table: tableName, fields: fieldsArray });

      if (res.success) {
        alertBox.innerHTML = `<div class="alert alert-success">‚úÖ Table <b>${tableName}</b> created!</div>`;
        let count = parseInt(document.getElementById('statTables').innerText) + 1;
        document.getElementById('statTables').innerText = count;
        saveState('maung_stat_tables', count);
        
        generateInsertForm(tableName, fieldsArray);
      } else {
        alertBox.innerHTML = `<div class="alert alert-error">‚ùå ${res.error}</div>`;
        document.getElementById('insertDataContainer').style.display = 'none';
      }
    }

    function generateInsertForm(tableName, fields) {
      const container = document.getElementById('insertDataContainer');
      container.style.display = 'block'; 
      
      let inputsHtml = '';
      fields.forEach((field, index) => {
        // field format: "name:TYPE" or "name:TYPE(ARGS)"
        // Split manual pikeun aman
        const separatorIdx = field.indexOf(':');
        const colName = field.substring(0, separatorIdx);
        const colTypeFull = field.substring(separatorIdx + 1).toUpperCase();
        
        let inputHtml = '';

        if (colTypeFull.startsWith('ENUM')) {
            // Extract ENUM(A,B) -> [A, B]
            const content = colTypeFull.substring(colTypeFull.indexOf('(') + 1, colTypeFull.lastIndexOf(')'));
            const options = content.split(',');
            
            let opts = options.map(o => `<option value="${o}">${o}</option>`).join('');
            inputHtml = `<select class="insert-input" required>${opts}</select>`;
        
        } else if (colTypeFull === 'BOOL') {
            inputHtml = `<select class="insert-input" required><option value="true">True</option><option value="false">False</option></select>`;
        
        } else if (colTypeFull === 'DATE') {
            inputHtml = `<input type="date" class="insert-input" required>`;
        
        } else if (colTypeFull === 'INT' || colTypeFull === 'FLOAT') {
            inputHtml = `<input type="number" step="any" class="insert-input" placeholder="0" required>`;
        
        } else {
            inputHtml = `<input type="text" class="insert-input" placeholder="..." required>`;
        }

        inputsHtml += `
          <div class="form-group">
            <label style="font-size:0.85rem; color:var(--text-muted);">
                ${colName} <span class="type-badge">${colTypeFull}</span>
            </label>
            ${inputHtml}
          </div>
        `;
      });

      container.innerHTML = `
        <h3 style="color:var(--primary); margin-bottom:15px;">Insert Data into '${tableName}'</h3>
        <form onsubmit="event.preventDefault(); submitInsertData('${tableName}');">
          <div class="insert-grid">${inputsHtml}</div>
          <button type="submit" class="btn-primary" style="margin-top: 20px; width: 100%; background-color: var(--success);">+ Insert Row</button>
        </form>
        <div id="insertResult"></div>
      `;
    }

    async function submitInsertData(tableName) {
       const inputs = document.querySelectorAll('.insert-input');
       const values = Array.from(inputs).map(input => input.value);
       const dataString = values.join('|');
       const query = `simpen ${tableName} ${dataString}`;
       
       const resultDiv = document.getElementById('insertResult');
       resultDiv.innerHTML = '<div style="margin-top:10px; color:var(--text-muted);">‚è≥ Inserting...</div>';
       
       const res = await API.post("/query", { query: query });
       
       if(res.success) {
          resultDiv.innerHTML = `<div class="alert alert-success">‚úÖ Data inserted!</div>`;
          // Reset inputs (keep selects at index 0)
          inputs.forEach(input => {
              if(input.tagName === 'SELECT') input.selectedIndex = 0;
              else input.value = '';
          });
          let newCount = parseInt(document.getElementById('statQueries').innerText) + 1;
          document.getElementById('statQueries').innerText = newCount;
          saveState('maung_stat_queries', newCount);
       } else {
          resultDiv.innerHTML = `<div class="alert alert-error">‚ùå ${res.error}</div>`;
       }
    }


    // --- 7. DATA MIGRATION LOGIC ---
    function doExport() {
        const table = document.getElementById('exportTableName').value;
        if(!table) { alert("Please enter table name!"); return; }
        

        window.location.href = `/db/export?table=${table}`;
    }

    async function doImport() {
        const table = document.getElementById('importTableName').value;
        const fileInput = document.getElementById('importFile');
        const alertBox = document.getElementById('migrationAlert');

        if(!table || fileInput.files.length === 0) { return; }

        const formData = new FormData();
        formData.append("table", table);
        formData.append("csv_file", fileInput.files[0]);

        alertBox.innerHTML = '<div style="color:blue;">‚è≥ Uploading & Processing...</div>';

        try {
            const raw = await fetch('/db/import', {
                method: 'POST',
                body: formData
            });
            const res = await raw.json();

            if(res.success) {
                alertBox.innerHTML = `<div class="alert alert-success">${res.message}</div>`;
                // Refresh stats
                let newCount = parseInt(document.getElementById('statTables').innerText); 
                // (Optional: update row count stats if you have it)
            } else {
                alertBox.innerHTML = `<div class="alert alert-error">‚ùå ${res.error}</div>`;
            }
        } catch(e) {
            alertBox.innerHTML = `<div class="alert alert-error">‚ùå Connection Error</div>`;
        }
    }

  </script>
</body>
</html>